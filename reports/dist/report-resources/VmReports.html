<!DOCTYPE html>
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
   <link href="resource/bootstrap-3.3.6-dist/css/bootstrap.min.css" rel="stylesheet">
   <link href="resource/bootstrap-datepicker/bootstrap-datepicker.css" rel="stylesheet">
   <link href="resource/bootstrap-datetimepicker/bootstrap-datetimepicker.min.css" rel="stylesheet">
   <script src="resource/jquery-2.2.2.js"></script>
   <script src="resource/bootstrap-3.3.6-dist/js/bootstrap.min.js"></script>
   <script src="resource/bootstrap-datepicker/bootstrap-datepicker.js"></script>
   <script src="resource/bootstrap-datetimepicker/bootstrap-datetimepicker.js"></script>
   <script src="resource/bootstrap-datetimepicker/bootstrap-datetimepicker.zh-CN.js"></script>
   <script src="resource/Chart.js/Chart.js"></script>
   <script src="resource/color.js"></script>
   <script type="text/javascript">
      window.onload=function(){
	 var button = document.getElementById("sure");
         $("body").width = document.body.scrollWidth;
         var padding = $(".container").css('padding-right').split('p')[0];
         $(".container").css("width", document.body.scrollWidth - padding);
         $(".container").css("height", $(window).height());

         <!--每当日期变化时，会调用如下函数-->
	 $("#period").change(function(){
            var data = {};
            data["vm_id"] = window.location.href.split("#")[1];
	    var checkIndex=$("#period").get(0).selectedIndex;
            for (var i = 0; i < 3; i ++){
	       if (checkIndex == i){
	          $(".time" + i).css('display','inline'); 
	       }
               else{
		  $(".time" + i).css('display','none'); 
	       }
            }
            if(checkIndex === 0){
               $('.form_datetime').datetimepicker({
		  weekStart: 0,
		  todayBtn:  1,
		  autoclose: 1,
		  todayHighlight: 1,
		  startView: 4,
                  minView: 0,
		  forceParse: 0,
		  minuteStep: 1
		  //startDate: "2015-10-20 12:00:02",
		  //endDate: "2016-04-25 10:00:00"
	       });
               data["period"] = "MINUTE";
	    }
            if(checkIndex === 1){
               $('.form_date').datetimepicker({
		  weekStart: 0,
		  todayBtn:  1,
		  autoclose: 1,
		  todayHighlight: 1,
		  startView: 4,
		  minView: 1,
		  forceParse: 0,
		  minuteStep: 1
		  //startDate: "2015-10-20 12",
		  //endDate: "2016-04-25 10"
               });
               data["period"] = "HOUR";
            }
	    if(checkIndex === 2){
	       $('#sandbox-container .input-group.date').datepicker({
		  format: "yyyy-mm-dd",
		  weekStart: 0,
		  //startDate: "2015-10-20",
		  //endDate: "2016-04-25",
		  startView: 2,
		  minViewMode: 0,
		  todayBtn: "linked",
		  orientation: "auto",
	 	  autoclose: true
	       });
               data["period"] = "DAY";
	    }
            var url = "/ovirt-engine-webadmin-reports/GETVMSTARTTIMEANDENDTIME/" + data["vm_id"] + "?period=" + data["period"];
	    $.ajax({
	       type: "GET",
	       url: url,
	       headers: {"Content-Type":"application/json"},
	       success: function(data) {
		  var time = data.split("'");
		  if(checkIndex === 0){
                     if (time.length == 1){
                        $('.form_datetime').datetimepicker('setStartDate', '2016-01-01');
                        $('.form_datetime').datetimepicker('setEndDate', '2015-01-01');
                     }
                     else {
			$('.form_datetime').datetimepicker('setStartDate', time[1]);
			$('.form_datetime').datetimepicker('setEndDate', time[3]);
                     }
		  }
		  else if(checkIndex === 1){
                     if (time.length == 1){
                        $('.form_date').datetimepicker('setStartDate', '2016-01-01');
                        $('.form_date').datetimepicker('setEndDate', '2015-01-01');
                     }
		     $('.form_date').datetimepicker('setStartDate', time[1]);
		     $('.form_date').datetimepicker('setEndDate', time[3]);
		  }  
		  else{
                     if (time.length == 1){
                        $('#sandbox-container .input-group.date').datepicker('setStartDate', '2016-01-01');
                        $('#sandbox-container .input-group.date').datepicker('setEndDate', '2015-01-01');

                     }
                     else {
			$('#sandbox-container .input-group.date').datepicker('setStartDate', time[1]);
			$('#sandbox-container .input-group.date').datepicker('setEndDate', time[3]);
                     }
		  } 
	       }
	    })
         });

         // 用户在选择日期这个动作结束时，才触发该方法----------------------------------
	 function valuechange(element,callback) {
	    var timer = 0,
	    prevVal = $(element).val();
	    timer = 0;
	    if(timer){
	       clearInterval(timer);
	       timer = 0;
	    }    
	    timer = setInterval(function(){
	       if(prevVal != $(element).val()) {
		  if(prevVal == '') {
		      prevVal = undefined;
		  }
		  callback(prevVal,$(element).val());
		  prevVal = $(element).val();
	       }
	    },100);

	    $(element).bind("propertychange input",function(e){
	       if(prevVal != $(e.target).val()) {
		   if(prevVal == '') {
		       prevVal = undefined;
		   }
		   callback(prevVal,$(e.target).val());
		   prevVal = $(e.target).val();
	       }
	    });
	 }
	 valuechange('#endingToMinute',function(prev,cur){
	    var checkIndex=$("#period").get(0).selectedIndex;
	    if (checkIndex === 0 && $("#startingToMinute").val().length != 0) {
               if ($("#startingToMinute").val() > $("#endingToMinute").val()){
		  alert("起始时间不能晚于终止时间");
                  $("#endingToMinute").val("");
               }
	    }
         });
         valuechange('#endingToHour',function(prev,cur){
            var checkIndex=$("#period").get(0).selectedIndex;
            if (checkIndex === 1 && $("#startingToHour").val().length != 0) {
               if ($("#startingToHour").val() > $("#endingToHour").val()){
                  alert("起始时间不能晚于终止时间");
                  $("#endingToHour").val("");
               }
            }
         });
	 valuechange('#endingToDate',function(prev,cur){
            var checkIndex=$("#period").get(0).selectedIndex;
            if (checkIndex === 2 && $("#startingToDate").val().length != 0) {
               if ($("#startingToDate").val() > $("#endingToDate").val()){
                  alert("起始时间不能晚于终止时间");
                  $("#endingToDate").val("");
               }
            }
         });

         valuechange('#startingToMinute',function(prev,cur){
            var checkIndex=$("#period").get(0).selectedIndex;
            if (checkIndex === 0 && $("#endingToMinute").val().length != 0) {
               if ($("#startingToMinute").val() > $("#endingToMinute").val()){
                  alert("起始时间不能晚于终止时间");
                  $("#startingToMinute").val("");
               }
            }
         });
         valuechange('#startingToHour',function(prev,cur){
            var checkIndex=$("#period").get(0).selectedIndex;
            if (checkIndex === 1 && $("#endingToHour").val().length != 0) {
               if ($("#startingToHour").val() > $("#endingToHour").val()){
                  alert("起始时间不能晚于终止时间");
                  $("#startingToHour").val("");
               }
            }
         });
         valuechange('#startingToDate',function(prev,cur){
            var checkIndex=$("#period").get(0).selectedIndex;
            if (checkIndex === 2 && $("#endingToDate").val().length != 0) {
               if ($("#startingToDate").val() > $("#endingToDate").val()){
                  alert("起始时间不能晚于终止时间");
                  $("#startingToDate").val("");
               }
            }
         });
      }
   </script>
   <style type="text/css">
      body .container{
         width: 100%;
         height: 100%;
      }
      #divLabel {
         vertical-align: text-bottom;
         margin-top: 8px;
      }
      label {
         color: #898989;
         text-align: center;
      }
      .row {
         margin-top: 2px;
      }
      .container {
	 padding-top: 0px;
	 padding-left: 0px;
         margin-left: 0px;
         margin-right: 0px;
      }
      .col-xs-8 {
         padding-right: 0px;
         padding-left: 0px;
      }
   </style>
</head>
<body>
   <div class="container">
      <div class="row">
         <div class="col-xs-2">
            <div class="row">
               <div class="col-xs-4" id="divLabel">
                  <label for="name">查看对象</label>
               </div>
               <div class="col-xs-8">
                  <select id="contentViewed" class="form-control">
                  </select>
               </div>
               <script>
	          $(document).ready(function(){
		     var data = {};
		     data["vm_id"] = window.location.href.split("#")[1];
		     var url = "/ovirt-engine-webadmin-reports/IFVMINTERFACEANDDISKEXIST/" + data["vm_id"];
                     $.ajax({
		        type: "GET",
			url: url,
			headers: {"Content-Type":"application/json"},
                        success: function(data) {
		           if(data == 0){
		              $("#contentViewed").html("<option>CPU</option><option>内存</option>");
			   }
		           else if(data == 1){
			      $("#contentViewed").html("<option>CPU</option><option>内存</option><option>磁盘空间</option");
			   }
		           else if(data == 2){
			      $("#contentViewed").html("<option>CPU</option><option>内存</option><option>网络</option>");
			   }
			   else{
			      $("#contentViewed").html("<option>CPU</option><option>内存</option><option>磁盘空间</option><option>网络</option>");
			   }
			}
		     })	     
		     /*var url = "/ovirt-engine-webadmin-reports/GETVMSTARTTIMEANDENDTIME/" + data["vm_id"] + "?period=MINUTE"
		     $('.form_datetime').datetimepicker({
			weekStart: 0,
			todayBtn:  1,
			autoclose: 1,
			todayHighlight: 1,
			startView: 4,
			forceParse: 0,
			minuteStep: 1,
		     });
		     $.ajax({
			type: "GET",
			url: url,
			headers: {"Content-Type":"application/json"},
			success: function(data) {
			   var time = data.split("'");
			   $('.form_datetime').datetimepicker('setStartDate', time[1]);
			   $('.form_datetime').datetimepicker('setEndDate', time[3]);
			}
		     })*/
		  });
	       </script>
            </div>
         </div>
	 <div class="col-xs-2">   
            <div class="row">
               <div class="col-xs-4" id="divLabel">
                  <label for="name">日期范围</label>
               </div>
               <div class="col-xs-8">
                  <select id="period" class="form-control">
                     <option>按分</option>
                     <option>按时</option>
                     <option>按日</option>
                  </select>
               </div>
            </div>
         </div>
         <div class="col-xs-2">   
            <div class="row">
               <div class="col-xs-4" id="divLabel">
                  <label for="name">起始时间</label>
               </div>
               <!--按分钟-->
	       <div class="col-xs-8 time0" style="display: inline">
                  <div class="input-group date form_datetime" data-date="1979-09-16T05:25:07Z" data-date-format="yyyy-mm-dd hh:ii" data-link-field="dtp_input1">
                     <input class="form-control" id="startingToMinute" size="16" type="text" value="" readonly>
                     <span class="input-group-addon startTimeSpan"><span class="glyphicon glyphicon-th"></span></span>
                  </div>
               </div>  
 	       <!--按时-->
               <div class="col-xs-8 time1" style="display: none">
		  <div class="input-group date form_date" data-date="1979-09-16T05:00" data-date-format="yyyy-mm-dd hh:ii" data-link-field="dtp_input1">
		     <input class="form-control" id="startingToHour" size="16" type="text" value="" readonly>
		     <span class="input-group-addon startTimeSpan"><span class="glyphicon glyphicon-th"></span></span>
		  </div>
	       </div>
               <!--按日-->
	       <div class="span5 col-xs-8 time2" id="sandbox-container" style="display: none">
		  <div class="input-group date">
		    <input type="text" id="startingToDate" class="form-control">
	            <span class="input-group-addon startTimeSpan"><i class="glyphicon glyphicon-th"></i></span>
		  </div>
	       </div>
            </div>
         </div>
         <div class="col-xs-2">   
            <div class="row">
               <div class="col-xs-4" id="divLabel">
                  <label for="name">终止时间</label>
	       </div>
               <!--按分钟-->
               <div class="col-xs-8 time0" style="display: inline">
                  <div class="input-group date form_datetime" data-date="1979-09-16T05:25:07Z" data-date-format="yyyy-mm-dd hh:ii" data-link-field="dtp_input1">
                     <input class="form-control" id="endingToMinute" size="16" type="text" value="" readonly>
                     <span class="input-group-addon"><span class="glyphicon glyphicon-th"></span></span>
                  </div>
               </div>
               <!--按时-->
               <div class="col-xs-8 time1" style="display: none">
                  <div class="input-group date form_date terminal_date" data-date="1979-09-16T05:00" data-date-format="yyyy-mm-dd hh:00" data-link-field="dtp_input1">
                     <input class="form-control" id="endingToHour" size="16" type="text" value="" readonly>
                     <span class="input-group-addon"><span class="glyphicon glyphicon-th"></span></span>
                  </div>
               </div>
               <!--按日-->
               <div class="span5 col-xs-8 time2 terminal_date" id="sandbox-container" style="display: none">
                  <div class="input-group date">
                    <input type="text" id="endingToDate" class="form-control">
                    <span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                  </div>
               </div>
            </div>
         </div>
         <div class="col-xs-2">   
            <div class="row">
               <div class="col-xs-4" id="divLabel">
                  <label for="name">查看方式</label>
               </div>
               <div class="col-xs-8">
                  <select id="method" class="form-control">
                     <option>--请选择显示方式--</option>
                     <option>曲线图</option>
                     <option>柱状图</option>
                     <option>雷达图</option>
                  </select>
               </div>
            </div>
         </div>  
	 <div class="col-xs-1">
            <div class="row">
	       <div class="col-xs-12">
		  <button id="sure" type="submit" class="btn btn-default" onclick="submitSure()">确定</button>
	       </div>
            </div>
	 </div>
      </div>
      <div class="row">   
	 <div class="col-xs-12" id="col9">
	    <canvas id="myLineChart"></canvas>
            <canvas id="myBarChart"></canvas>
            <canvas id="myRadarChart"></canvas>
	 </div>
      </div>
   </div>
   <script>
      // 在选择查看方式之前，前四个选择框内不可为空。
      $('#method').click(function(){
         var contentViewed = $("#contentViewed").get(0).selectedIndex;
         var checkIndex = $("#period").get(0).selectedIndex;
         var data = {};
         data["vm_id"] = window.location.href.split("#")[1];
         if (checkIndex === 0){
            if ($("#startingToMinute").val().length === 0 || $("#endingToMinute").val().length === 0){
               $('#method').get(0).selectedIndex = 0;
               alert("请选择起始时间和终止时间！");
            }
            else {
               data["period"] = "MINUTE";
	       data["startingTime"] = $("#startingToMinute").val();
	       data["terminalTime"] = $("#endingToMinute").val();
            }
         }
         else if (checkIndex === 1){
            if ($("#startingToHour").val().length === 0 || $("#endingToHour").val().length === 0){
               alert("请选择起始时间和终止时间！");
            }
            else {
	       data["period"] = "HOUR";
	       data["startingTime"] = $("#startingToHour").val();
	       data["terminalTime"] = $("#endingToHour").val();
            }
         }
         else{
            if ($("#startingToDate").val().length === 0 || $("#endingToDate").val().length === 0){
               alert("请选择起始时间和终止时间！");
            }
            else {
	       data["period"] = "DAY";
	       data["startingTime"] = $("#startingToDate").val();
	       data["terminalTime"] = $("#endingToDate").val();
            }
         }
         if (contentViewed === 3){
            var url = "/ovirt-engine-webadmin-reports/GETNUMOFVMINTERFACEINONEPERIOD/" + data["vm_id"] + "?period=" + data["period"] + "&startingTime=" + data["startingTime"] + "&terminalTime=" + data["terminalTime"];
            var networkCanvas = document.getElementsByClassName('networkCanvas');
            if (networkCanvas.length != 0){
               $('.networkCanvas').remove();
            }
            $.ajax({
               type: "GET",
               url: url,
               headers: {"Content-Type":"application/json"},
               success: function(data) {
                  for (var i = 0; i < data; i ++){
		     $("#col9").append("<canvas id='myLineChart" + i + "' class='networkCanvas'></canvas>");
		     $("#col9").append("<canvas id='myBarChart" + i + "' class='networkCanvas'></canvas>");
		     $("#col9").append("<canvas id='myRadarChart" + i + "' class='networkCanvas'></canvas>");
                  }
               }
            });
         }
      });
      window.onresize = function(){
         ch = $(window).height();
         $("body").width = document.body.scrollWidth;
         var padding = $(".container").css('padding-right').split('p')[0];
         $(".container").css("width", document.body.scrollWidth - padding);
      }
      // 报表
      var cw = col9.clientWidth; // number
      var ch = $(window).height();
      var canvas = document.getElementsByTagName("canvas");
      var ctx = null;
      var myChart = new Array(3);
            
      function submitSure(){
	 var data = {};
	 data["vm_id"] = window.location.href.split("#")[1];
	 var contentViewed = $("#contentViewed").get(0).selectedIndex;
	 var checkIndex = $("#period").get(0).selectedIndex;
	 if (contentViewed === 0){
	    data["contentViewed"] = "CPU";
	 }
	 else if (contentViewed === 1){
	    data["contentViewed"] = "Memory";
	 }
	 else if (contentViewed === 2){
	    data["contentViewed"] = "Disks";
	 }
	 else {
	    data["contentViewed"] = "Network";
	 }
	 if(checkIndex === 0){
	    data["period"] = "MINUTE";
	    data["startingTime"] = $("#startingToMinute").val();
	    data["terminalTime"] = $("#endingToMinute").val();
	 }
	 else if (checkIndex === 1){
	    data["period"] = "HOUR";
	    data["startingTime"] = $("#startingToHour").val();
	    data["terminalTime"] = $("#endingToHour").val();
	 }
	 else{
	    data["period"] = "DAY";
	    data["startingTime"] = $("#startingToDate").val();
	    data["terminalTime"] = $("#endingToDate").val();
	 }
	 var method_selected = $("#method").get(0).selectedIndex;
         if (method_selected === 0){
            alert("请选择查看方式！");
         }
         var url = "/ovirt-engine-webadmin-reports/VMREPORTS/" + data["vm_id"] + "?contentViewed=" + data["contentViewed"] + "&period=" + data["period"] + "&startingTime=" + data["startingTime"] + "&terminalTime=" + data["terminalTime"];
	 $.ajax({
	    type: "GET",
	    url: url,
	    headers: {"Accept":"application/json"},
	    success: function(result) {
               for (var k = 0; k < DATA.datasets.length; k ++){
                  DATA.datasets[k].label = null;
                  DATA.datasets[k].data = null;
               }
               // 需要多少条线
               // 如果是 cpu 或 mem 的话，最多 2 个
               if (contentViewed === 0) {
                  var cv0 = new Array();
                  if(result[0].max_cpu_usage != undefined){
                     var cv1 = new Array();
		  }
               }
               else if (contentViewed === 1) {
                  var mv0 = new Array();
                  if(result[0].max_memory_usage != undefined){
                     var mv1 = new Array();
                  }
               }
               // disk 的话，就是 max - 1 个
               else if (contentViewed === 2) {
                  var dv = new Array();
                  var numOfVer = Object.keys(result[0]).length - 1;
                  for (var i = 0; i < numOfVer; i ++){
                     dv[i] = new Array();
                  }
	       }
               // network 共有 result.length * 2 个。
               else {
                  var nv = new Array();
                  for (var i = 0; i < result.length; i ++){
                     nv[i] = new Array(2);
                     for (var j = 0; j < 2; j ++){
                        nv[i][j] = new Array(result[i].length);
                     }
                  }
               }
               // 获取用户选择的初始时间，目的是作为横坐标的第一个标示点。
               var v_date = new Array();
               if(checkIndex === 0){
                  if (contentViewed === 3){
                     var hour = new Array();
                     for (var i = 0; i < result.length; i ++) {
                        hour[i] = result[i][0].history_datetime.split(' ')[1].split(':')[0];
                     }
                  }
                  else if (contentViewed === 2){
		     var hour = Object.keys(result[0])[0].split(' ')[1].split(':')[0];
                  }
                  else {
                     var hour = result[0].history_datetime.split(' ')[1].split(':')[0];
                  }
               }
               else if(checkIndex === 1){
                  if (contentViewed === 3){
                     var day = new Array();
                     for (var i = 0; i < result.length; i ++) {
                        day[i] = result[i][0].history_datetime.split(' ')[0].split('-')[2];
                     }
                  }
                  else if (contentViewed === 2) {
                     var day = Object.keys(result[0])[0].split(' ')[0].split('-')[2];
                  }
                  else {
                     var day = result[0].history_datetime.split(' ')[0].split('-')[2];
                  }
               }
               else{
                  if (contentViewed === 3){
                     var month = new Array();
                     for (var i = 0; i < result.length; i ++) {
                        month[i] = result[i][0].history_datetime.split('-')[1];   
                     }
                  }
                  else if (contentViewed === 2) {
                     var month = Object.keys(result[0])[0].split('-')[1];
                  }
                  else {
                     var month = result[0].history_datetime.split('-')[1];
                  }
               }
               for (var i = 0; i < result.length; i ++){
		  if (contentViewed === 0){
		     cv0[i] = result[i].cpu_usage_percent;
                     DATA.datasets[0].label = 'cpu_usage_percent';
                     if(result[i].max_cpu_usage != undefined){
                        cv1[i] = result[i].max_cpu_usage;
                        DATA.datasets[1].label = 'max_cpu_usage';
                     }
                     if (checkIndex === 0){
                        var h = result[i].history_datetime.split(' ')[1].split(':')[0];
                        if (i == 0 || hour != h){
			   v_date[i] = result[i].history_datetime;
                           hour = h;
			}
                        else{
                           v_date[i] = "";
			}
                     }
                     else if (checkIndex === 1){
			var d = result[i].history_datetime.split(' ')[0].split('-')[2];
                        if (i == 0 || day != d){
                           v_date[i] = result[i].history_datetime;
                           day = d;
                        }
                        else{
                           v_date[i] = "";
                        }
		     }
                     else{
                        var m = result[i].history_datetime.split('-')[1];
                        if (i == 0 || month != m){
                           v_date[i] = result[i].history_datetime;
                           month = m;
                        }
                        else{
                           v_date[i] = "";
                        }
		     }
                  }
		  else if (contentViewed === 1){
		     mv0[i] = result[i].memory_usage_percent;
                     DATA.datasets[0].label = 'memory_usage_percent';
                     if(result[i].max_cpu_usage != undefined){
			mv1[i] = result[i].max_memory_usage;
			DATA.datasets[1].label = 'max_memory_usage';
                     }
                     if (checkIndex === 0){
                        var h = result[i].history_datetime.split(' ')[1].split(':')[0];
                        if (i == 0 || hour != h){
                           v_date[i] = result[i].history_datetime;
                           hour = h;
                        }
                        else{
                           v_date[i] = "";
                        }
                     }
                     else if (checkIndex === 1){
                        var d = result[i].history_datetime.split(' ')[0].split('-')[2];
                        if (i == 0 || day != d){
                           v_date[i] = result[i].history_datetime;
                           day = d;
                        }
                        else{
                           v_date[i] = "";
                        }
                     }
                     else{
                        var m = result[i].history_datetime.split('-')[1];
                        if (i == 0 || month != m){
                           v_date[i] = result[i].history_datetime;
                           month = m;
                        }
                        else{
                           v_date[i] = "";
                        }
                     }
	          }
                  else if(contentViewed === 2){
                     for(var j = 0; j < numOfVer; j ++){
                        // 由于每个map中的第一个是日期，真正的使用率是从1开始的
                        var key_path = Object.keys(result[i])[j + 1];
                        var key_path_obj = Object.getOwnPropertyDescriptor(result[i], key_path);
                        dv[j][i] = key_path_obj.value;
                        DATA.datasets[j].label = key_path;
                     }
		     if (checkIndex === 0){
			var h = Object.keys(result[i])[0].split(' ')[1].split(':')[0];
			if (i == 0 || hour != h){
			   v_date[i] = Object.keys(result[i])[0];
			   hour = h;
			}
			else{
			   v_date[i] = "";
			}
		     }
		     else if (checkIndex === 1){
			var d = Object.keys(result[i])[0].split(' ')[0].split('-')[2];
			if (i == 0 || day != d){
			   v_date[i] = Object.keys(result[i])[0];
			   day = d;
			}
			else{
			   v_date[i] = "";
			}
		     }
		     else{
			var m = Object.keys(result[i])[0].split('-')[1];
			if (i == 0 || month != m){
			   v_date[i] = Object.keys(result[i])[0];
			   month = m;
			}
			else{
			   v_date[i] = "";
			}
		     }
                  }
                  else {
		     for (var j = 0; j < 2; j ++){
			for (var k = 0; k < result[i].length; k ++){
			   if (j == 0){
			      nv[i][j][k] = result[i][k].receive_rate_percent > result[i][k].transmit_rate_percent ? result[i][k].receive_rate_percent : result[i][k].transmit_rate_percent;
			   }
			   else {
			      nv[i][j][k] = result[i][k].max_receive_rate_percent > result[i][k].max_transmit_rate_percent ? result[i][k].max_receive_rate_percent : result[i][k].max_transmit_rate_percent;
			   }
			}
		     } 
                     if (checkIndex === 0){
                        v_date[i] = new Array();
                        for (var k = 0; k < result[i].length; k ++) {
			   var h = result[i][k].history_datetime.split(' ')[1].split(':')[0];
			   if (k == 0 || hour[i] != h){
			      v_date[i][k] = result[i][k].history_datetime;
			      hour[i] = h;
			   }
			   else{
			      v_date[i][k] = "";
			   }
                        }
                     }
                     else if (checkIndex === 1){
                        v_date[i] = new Array();
                        for (var k = 0; k < result[i].length; k ++){
			   var d = result[i][k].history_datetime.split(' ')[0].split('-')[2];
			   if (k == 0 || day[i] != d){
			      v_date[i][k] = result[i][k].history_datetime;
			      day[i] = d;
			   }
			   else{
			      v_date[i][k] = "";
                           }
                        }
                     }
                     else{
                        v_date[i] = new Array();
                        for (var k = 0; k < result[i].length; k ++){
			   var m = result[i][k].history_datetime.split('-')[1];
			   if (k == 0 || month[i] != m){
			      v_date[i][k] = result[i][k].history_datetime;
			      month[i] = m;
			   }
			   else{
			      v_date[i][k] = "";
			   }
			}
                     }
                  }
               }
               // 给需要画的所有线赋予 data 值和 labels (横坐标)值
               if (contentViewed === 0){
		  DATA.datasets[0].data = cv0;
                  if (cv1 != null){
		     DATA.datasets[1].data = cv1;
                  }
               }
	       else if (contentViewed === 1){
                  DATA.datasets[0].data = mv0;
                  if (mv1 != null){
                     DATA.datasets[1].data = mv1;                  
                  }
               }
               else if (contentViewed === 2){
                  for (var i = 0; i < numOfVer; i ++){
                     DATA.datasets[i].data = dv[i];
                  } 
               }
               else{
                  var DATA_COPY = new Array();
                  for (var i = 0; i < result.length; i ++){
                     DATA_COPY[i] = $.extend(true, {}, DATA); 
                     for (var j = 0; j < 2; j ++){
                        if (j == 0){
			   DATA_COPY[i].datasets[j].label = result[i][j].vm_interface_name + "_rate_percent";
                        }
                        else {
			   DATA_COPY[i].datasets[j].label = result[i][j].vm_interface_name + "_max_rate_percent";
                        }
                        DATA_COPY[i].datasets[j].data = nv[i][j];
                     }
                  }               
               }
               var canvas = document.getElementsByTagName('canvas');
               var flag = 0;
               for (var i = 0 ; i < canvas.length; i ++){
                  canvas[i].style.display = "none";
               }
               if ($(".networkCanvas").size() != 0){
                  var canvas = document.getElementsByClassName("networkCanvas");
                  var numOfCanvasViewed = canvas.length / 3; // 其实就是网卡的数量
                  for (var i = 0; i < numOfCanvasViewed; i ++){
		     DATA_COPY[i].labels = v_date[i];
                  }
                  for (var i = 0; i < canvas.length; i ++){
                     if(myChart[i] != null){                                                     
                        myChart[i].destroy();                                                    
                     }                                                                           
                     canvas[i].setAttribute('width', cw);                                     
                     canvas[i].setAttribute('height', ch);                                       
                     canvas[i].style.width = String(cw) + "px";                                  
                     canvas[i].style.height = String(ch) + "px";                                 
                     canvas[i].style.display = "none";
                     // 3 是个数：曲线图，柱形图，雷达图；so, 0:曲线图 ,1:柱状图 ,2: 雷达图.也是固定的
		     if (method_selected == 1 && i % 3 == 0){                                                
			ctx = canvas[i].getContext("2d");           
			myChart[i] = new Chart(ctx).Line(DATA_COPY[flag]);                                                       
			canvas[i].style.display = "inline";                                                           
                        flag ++;
		     }                                                                                                
		     else if (method_selected == 2 && i % 3 == 1){                                                    
			ctx = canvas[i].getContext("2d");                                                             
			myChart[i] = new Chart(ctx).Bar(DATA_COPY[flag]);                                                        
			canvas[i].style.display = "inline";                                                           
                        flag ++;
		     }                                                                                                
		     else if (method_selected == 3 && i % 3 == 2){                                                    
			ctx = canvas[i].getContext("2d");                                                             
			myChart[i] = new Chart(ctx).Radar(DATA_COPY[flag]);                                                       
			canvas[i].style.display = "inline";                                              
                        flag ++;
		     }                         
                  }
               }
               else{
                  DATA.labels = v_date;
		  for (var i = 0; i < canvas.length; i ++){
		     if(myChart[i] != null){
			myChart[i].destroy();
		     }
		     canvas[i].setAttribute('width', cw);
		     canvas[i].setAttribute('height', ch);
		     canvas[i].style.width = String(cw) + "px";
		     canvas[i].style.height = String(ch) + "px";
		     canvas[i].style.display = "none";
		     if (method_selected == 1 && i + 1 == 1){
			ctx = canvas[i].getContext("2d");
			myChart[i] = new Chart(ctx).Line(DATA);
			canvas[i].style.display = "inline";
		     }
		     else if (method_selected == 2 && i + 1 == 2){
			ctx = canvas[i].getContext("2d");
			myChart[i] = new Chart(ctx).Bar(DATA);
			canvas[i].style.display = "inline";
		     }
		     else if (method_selected == 3 && i + 1 == 3){
			ctx = canvas[i].getContext("2d");      
			myChart[i] = new Chart(ctx).Radar(DATA)
			canvas[i].style.display = "inline";
		     }
                  }
               }
            }
         });
      }
   </script>
</body>
</html>
